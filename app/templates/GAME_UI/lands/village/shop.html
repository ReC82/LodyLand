{% extends "game_base.html" %}

{% block title %}Boutique du Village — LodyLand{% endblock %}

{% block content %}
<div class="village-shop-wrapper">

  <!-- Header -->
  <header class="village-shop-header mb-4">
    <h1 class="h3 mb-1">Boutique du Village</h1>
    <p class="text-muted mb-0">
      Ici, tu trouveras des objets spéciaux, en stock limité ou disponibles
      seulement pendant une courte période.
    </p>
  </header>

  <div class="village-shop-layout">

    <!-- Colonne principale : liste d'items -->
    <section class="village-shop-main">
      <div class="vs-card mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Objets en vitrine</h2>
        </div>

        {% if shop_items %}
        <div class="village-shop-grid">
            {% set group = namespace(current_villager = None) %}

            {% for item in shop_items %}

            {# --- Nouveau villageois ? On ajoute un titre de section --- #}
            {% if item.villager != group.current_villager %}
                {% if not loop.first %}
                <hr class="vs-villager-separator" />
                {% endif %}
                <h3 class="vs-villager-title">
                Offres de {{ item.villager }}
                </h3>
                {% set group.current_villager = item.villager %}
            {% endif %}

            <article class="vs-item-card">

                <!-- Colonne gauche : portrait + nom -->
                <div class="vs-item-left">
                <div class="vs-item-icon">
                    {% if item.villager %}
                    {% set villager_img = "/static/assets/img/pnj/villagers/" ~ item.villager ~ ".png" %}
                    <img
                        src="{{ villager_img }}"
                        alt="Portrait de {{ item.villager }}"
                        class="vs-item-portrait"
                    />
                    {% else %}
                    <span class="vs-item-initial">
                        {{ item.label[:1] }}
                    </span>
                    {% endif %}
                </div>

                {% if item.villager %}
                    <div class="vs-villager-name">
                    {{ item.villager }}
                    </div>
                {% endif %}
                </div>

                <!-- Colonne droite : infos de l'item -->
                <div class="vs-item-body">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h3 class="h6 mb-0">{{ item.label }}</h3>
                    {% if item.rarity %}
                    <span class="vs-rarity vs-rarity-{{ item.rarity }}">
                        {{ item.rarity|capitalize }}
                    </span>
                    {% endif %}
                </div>

                <div class="d-flex flex-wrap gap-2 mb-2">
                  {% if item.owned_qty and item.owned_qty > 0 %}
                    <span class="badge bg-success">Déjà possédée</span>
                  {% endif %}

                  {% if item.limit_until %}
                    <span class="badge bg-dark">
                      ⏳ jusqu’au {{ item.limit_until }}
                    </span>
                  {% endif %}
                </div>                

                {% if item.description %}
                    <p class="vs-item-desc text-muted small mb-2">
                    {{ item.description }}
                    </p>
                {% endif %}

                <div class="vs-item-meta d-flex justify-content-between align-items-center">
                    <div class="vs-item-price small">
                    {% set coins = item.price_coins or 0 %}
                    {% set diams = item.price_diams or 0 %}

                    {% if coins == 0 and diams == 0 %}
                        <span class="badge bg-success">Gratuit</span>
                    {% else %}
                        {% if coins %}
                        <span class="me-2">
                            <span class="ui-icon ui-icon-coin"></span>
                            {{ coins }}
                        </span>
                        {% endif %}
                        {% if diams %}
                        <span>
                            <span class="ui-icon ui-icon-diam"></span>
                            {{ diams }}
                        </span>
                        {% endif %}
                    {% endif %}
                    </div>

                    <div class="vs-item-stock small text-muted">
                    {% if item.stock is not none and item.stock < 999 %}
                        Stock: {{ item.stock }}
                    {% else %}
                        Stock: Illimité
                    {% endif %}
                    </div>
                </div>

                <div class="mt-2 text-end">
                  <button
                    class="btn btn-sm {% if item.can_buy %}btn-outline-primary vs-buy-btn{% else %}btn-outline-secondary{% endif %}"
                    data-offer-key="{{ item.offer_key }}"
                    {% if not item.can_buy %}disabled="disabled"{% endif %}
                    {% if item.cant_buy_reason %}title="{{ item.cant_buy_reason }}"{% endif %}
                  >
                    {% if item.can_buy %}
                      Acheter
                    {% else %}
                      Impossible
                    {% endif %}
                  </button>
                </div>


            </article>

            {% endfor %}
        </div>
        {% else %}

          <p class="text-muted mb-0">
            Aucun objet en vente pour le moment. Plus tard, cette boutique proposera
            une rotation d'objets rares à ne pas rater.
          </p>
        {% endif %}
      </div>
    </section>

    <!-- Colonne latérale : infos rotation -->
    <aside class="village-shop-sidebar">
      <div class="vs-card">
        <h2 class="h6 mb-2">Comment fonctionne cette boutique ?</h2>
        <p class="text-muted small mb-2">
          À terme, cette boutique proposera une sélection d'objets rares.
          Chaque objet aura :
        </p>
        <ul class="small text-muted mb-2">
          <li>un stock limité ou illimité,</li>
          <li>un coût en coins, en diams ou en ressources,</li>
          <li>une durée de disponibilité (rotation).</li>
        </ul>
        <p class="text-muted small mb-0">
          Pour l’instant, l’écran est en mode démonstration (UI only) pour
          préparer la vraie logique d’achats et de rotations.
        </p>
      </div>
    </aside>

  </div>

</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{{ url_for('static', filename='GAME_UI/js/village/village_shop.js') }}"></script>
{% endblock %}
