<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Documentation â€” Ajouter un Land</title>
<style>
  body {
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f7f7fb;
    line-height: 1.6;
    color: #333;
  }

  header {
    background: #4a6fa5;
    color: white;
    padding: 2rem 1rem;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }

  h1 {
    margin: 0;
    font-size: 2rem;
  }

  h2 {
    margin-top: 2rem;
    color: #26416b;
  }

  h3 {
    margin-top: 1.5rem;
    color: #375a7f;
  }

  .container {
    max-width: 950px;
    margin: 0 auto;
    padding: 2rem;
  }

  pre {
    background: #272822;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 0.9rem;
  }

  code {
    background: #e8e8e8;
    padding: 2px 4px;
    border-radius: 4px;
  }

  ul {
    margin-left: 1rem;
  }

  .box {
    background: white;
    padding: 1.2rem 1.4rem;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.09);
    margin-bottom: 2rem;
  }

  .important {
    background: #fff7d4;
    border-left: 5px solid #ffcd00;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 5px;
  }

  .tip {
    background: #dff4ff;
    border-left: 5px solid #52baff;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 5px;
  }

  .toc a {
    text-decoration: none;
    color: #375a7f;
  }
  
  .toc a:hover {
    text-decoration: underline;
  }
</style>
</head>

<body>

<header>
  <h1>Guide complet : Ajouter un Land dans LodyLand</h1>
</header>

<div class="container">

<div class="box toc">
  <h2>ğŸ“š Table des matiÃ¨res</h2>
  <ul>
    <li><a href="#principes">0. Principe gÃ©nÃ©ral dâ€™un Land</a></li>
    <li><a href="#slug">1. Choisir un identifiant (slug)</a></li>
    <li><a href="#card">2. Ajouter la carte dâ€™accÃ¨s (cards.yml)</a></li>
    <li><a href="#selector">3. IntÃ©gration dans le sÃ©lecteur /lands</a></li>
    <li><a href="#route">4. Ajouter la route Flask</a></li>
    <li><a href="#template">5. CrÃ©er le template du land</a></li>
    <li><a href="#js">6. Ajouter le JS spÃ©cifique</a></li>
    <li><a href="#emoji">7. Ajouter lâ€™emoji du land</a></li>
    <li><a href="#lands-yml">8. Config gameplay (lands.yml + slots)</a></li>
    <li><a href="#slots-free">9. Slots supplÃ©mentaires & cartes Free Slot</a></li>
    <li><a href="#tldr">10. TL;DR â€” Checklist rapide</a></li>
  </ul>
</div>

<!-- ==================== SECTION 0 ==================== -->
<div class="box" id="principes">
<h2>0. ğŸ—ºï¸ Principe gÃ©nÃ©ral</h2>

<p>Dans LodyLand, un <strong>Land jouable</strong> est dÃ©fini par :</p>

<ul>
  <li>Une <strong>carte dâ€™accÃ¨s</strong> dans <code>cards.yml</code> (type <code>land_access</code>).</li>
  <li>Une <strong>route Flask</strong> (ex: <code>/land/village</code>).</li>
  <li>Un <strong>template HTML</strong> dans <code>GAME_UI/lands/</code>.</li>
  <li>Un <strong>fichier JS</strong> propre au land (optionnel mais recommandÃ©).</li>
  <li>Une entrÃ©e gameplay dans <code>lands.yml</code> (slots de base, icÃ´ne, coÃ»ts, loot, ...).</li>
</ul>

<div class="important">
Un land <strong>nâ€™apparaÃ®t dans /lands</strong> que sâ€™il existe une carte <code>land_*</code> dans
<code>card_defs</code> (type <code>land_access</code>).
</div>
</div>

<!-- ==================== SECTION 1 ==================== -->
<div class="box" id="slug">
<h2>1. ğŸ”¤ Choisir un identifiant (slug)</h2>

<p>Exemples valides :</p>

<ul>
  <li><code>forest</code></li>
  <li><code>beach</code></li>
  <li><code>village</code></li>
</ul>

<p>Correspondances obligatoires :</p>

<ul>
  <li>Carte dâ€™accÃ¨s : <code>land_&lt;slug&gt;</code> (ex : <code>land_beach</code>).</li>
  <li>Route Flask : <code>/land/&lt;slug&gt;</code></li>
  <li>Template HTML : <code>GAME_UI/lands/&lt;slug&gt;.html</code></li>
  <li>Script JS : <code>static/GAME_UI/js/lands/&lt;slug&gt;_app.js</code></li>
  <li>ClÃ© YAML : <code>&lt;slug&gt;</code> dans <code>lands.yml</code></li>
</ul>
</div>

<!-- ==================== SECTION 2 ==================== -->
<div class="box" id="card">
<h2>2. ğŸƒ Ajouter la carte dâ€™accÃ¨s dans cards.yml</h2>

<p>Fichier : <code>app/data/cards.yml</code></p>

<p>Exemple <strong>moderne</strong> avec le nouveau modÃ¨le (prices + shop) :</p>

<pre>
- key: land_beach
  label: "AccÃ¨s Plage"
  description: "Une plage ensoleillÃ©e pour fouiller le sable."
  icon: "/static/assets/img/cards/land_beach.png"
  type: "land_access"
  categorie: "lands"
  rarity: "common"

  gameplay: {}

  prices:
    - coins: 500      # 1Ã¨re option : 500 coins
      diams: 0

  shop:
    max_owned: 1      # le joueur peut en possÃ©der maximum 1

  enabled: true
</pre>

<p>RedÃ©marre l'application â†’ la fonction de seed synchronise les CardDef en DB.</p>
</div>

<!-- ==================== SECTION 3 ==================== -->
<div class="box" id="selector">
<h2>3. ğŸ”“ IntÃ©gration dans le sÃ©lecteur <code>/lands</code></h2>

<p>Le sÃ©lecteur est dynamique. Il charge :</p>

<ul>
  <li>Toutes les cartes dont la clÃ© commence par <code>land_</code>.</li>
  <li>VÃ©rifie si le joueur a achetÃ© la carte (via <code>PlayerCard</code>).</li>
  <li>Affiche un bouton <strong>DÃ©bloquÃ©</strong> ou <strong>VerrouillÃ©</strong> et un lien vers <code>/land/&lt;slug&gt;</code> si la route existe.</li>
</ul>

<div class="tip">
Donc : <strong>si tu ajoutes land_beach dans cards.yml â†’ il apparaÃ®t automatiquement dans /lands !</strong>
</div>
</div>

<!-- ==================== SECTION 4 ==================== -->
<div class="box" id="route">
<h2>4. ğŸ§© Ajouter la route Flask</h2>

<p>Dans <code>frontend.py</code> :</p>

<pre>
@frontend_bp.get("/land/beach")
def land_beach():
    session = SessionLocal()
    try:
        player = get_current_player(session)
        if not player:
            return redirect(url_for("frontend.home"))

        # VÃ©rifier carte d'accÃ¨s
        has_beach = (
            session.query(PlayerCard)
            .filter(
                PlayerCard.player_id == player.id,
                PlayerCard.card_key == "land_beach",
                PlayerCard.qty > 0,
            )
            .first()
        )
        if not has_beach:
            return redirect(url_for("frontend.lands_select"))

        from app.lands import get_player_land_state
        state = get_player_land_state(session, player.id, "beach")

        # Carte "free slot" pour la plage ?
        has_free_slot_card = (
            session.query(PlayerCard)
            .filter(
                PlayerCard.player_id == player.id,
                PlayerCard.card_key == "land_beach_free_slot",
                PlayerCard.qty > 0,
            )
            .count()
            > 0
        )

        return render_template(
            "GAME_UI/lands/beach.html",
            state=state,
            has_free_slot_card=has_free_slot_card,
        )
    finally:
        session.close()
</pre>
</div>

<!-- ==================== SECTION 5 ==================== -->
<div class="box" id="template">
<h2>5. ğŸ¨ CrÃ©er le template HTML</h2>

<p>Fichier : <code>templates/GAME_UI/lands/beach.html</code></p>

<pre>
{% raw %}{% extends "game_base.html" %}

{% block title %}Plage â€” LodyLand{% endblock %}

{% block content %}
<div class="land-container beach-land">
  &lt;!-- Header --&gt;
  &lt;h1 class="h3 mb-0"&gt;ğŸï¸ Plage&lt;/h1&gt;
  &lt;small class="text-muted"&gt;
    {{ state.total_slots }} emplacements ({{ state.base_slots }} de base, {{ state.extra_slots }} bonus)
  &lt;/small&gt;

  &lt;!-- Grille des slots --&gt;
  &lt;div class="slot-grid"&gt;
    {% for idx in range(state.total_slots) %}
    &lt;div class="slot-tile" data-slot="{{ idx }}"&gt;
      &lt;div class="slot-icon"&gt;
        &lt;img
          src="{{ url_for('static', filename=state.slot_icon.replace('static/', '')) }}"
          class="land-slot-icon"
        /&gt;
      &lt;/div&gt;
      &lt;div class="slot-index"&gt;Slot {{ idx + 1 }}&lt;/div&gt;
      &lt;div class="slot-label"&gt;Zone de sable&lt;/div&gt;
      &lt;div class="slot-status"&gt;Clique pour fouiller&lt;/div&gt;
    &lt;/div&gt;
    {% endfor %}
  &lt;/div&gt;

  &lt;!-- Tuile +1 emplacement (pleine largeur) --&gt;
  &lt;div class="slot-add-container"&gt;
    &lt;div
      class="slot-tile slot-add full-width"
      id="add-slot-btn"
      data-next-cost="{{ state.next_cost }}"
      data-has-free="{{ 1 if has_free_slot_card else 0 }}"
    &gt;
      &lt;div class="slot-icon"&gt;
        &lt;img src="{{ url_for('static', filename='assets/img/lands/add_slot.png') }}"
             class="land-slot-icon" /&gt;
      &lt;/div&gt;
      &lt;div class="slot-index"&gt;+1 emplacement&lt;/div&gt;
      &lt;div class="slot-label"&gt;
        {% if has_free_slot_card %}
          1 carte gratuite dispo ğŸŸï¸
        {% else %}
          CoÃ»t actuel : {{ state.next_cost }} ğŸ’
        {% endif %}
      &lt;/div&gt;
      &lt;div class="slot-status"&gt;Clique pour dÃ©bloquer&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
</div>

&lt;script src="{{ url_for('static', filename='GAME_UI/js/lands/beach_app.js') }}"&gt;&lt;/script&gt;
{% endblock %}{% endraw %}
</pre>
</div>

<!-- ==================== SECTION 6 ==================== -->
<div class="box" id="js">
<h2>6. âš™ï¸ Ajouter le JS du land</h2>

<p>Fichier : <code>static/GAME_UI/js/lands/beach_app.js</code></p>

<p>IdÃ©e : copier le script de la forÃªt et adapter le paramÃ¨tre <code>land</code> + lâ€™URL de lâ€™API :</p>

<pre>
// collectOnBeachSlot(...) â†’ POST /api/collect avec { land: "beach", slot: &lt;index&gt; }
// initBeachAddSlot(...) â†’ POST /api/lands/beach/slots/buy
</pre>
</div>

<!-- ==================== SECTION 7 ==================== -->
<div class="box" id="emoji">
<h2>7. ğŸ˜€ Ajouter un emoji pour la liste /lands</h2>

Dans <code>frontend.py</code> :

<pre>
EMOJI_BY_SLUG = {
    "forest": "ğŸŒ²",
    "beach": "ğŸï¸",
    "village": "ğŸ˜ï¸",
}
</pre>
</div>

<!-- ==================== SECTION 8 ==================== -->
<div class="box" id="lands-yml">
<h2>8. ğŸ“¦ Config gameplay (lands.yml + slots)</h2>

<p>Fichier : <code>app/data/lands.yml</code></p>

<pre>
forest:
  key: "land_forest"
  label_fr: "ForÃªt"
  label_en: "Forest"
  starting_land: true
  slots: 8
  slot_icon: "assets/img/lands/forest_slot.png"
  additional_slot_base_cost_diams: 10
  additional_slot_cost_multiplier: 1.5
  tools:
    hands:
      base_loot: ...
      extra_loot: ...

beach:
  key: "land_beach"
  label_fr: "Plage"
  label_en: "Beach"
  starting_land: false
  slots: 6
  slot_icon: "assets/img/lands/beach_slot.png"
  additional_slot_base_cost_diams: 15
  additional_slot_cost_multiplier: 1.6
  tools:
    hands:
      base_loot: ...
</pre>

<p><code>get_player_land_state()</code> lit cette config et applique ensuite les Ã©ventuels slots bonus de la table <code>player_land_slots</code>.</p>
</div>

<!-- ==================== SECTION 9 ==================== -->
<div class="box" id="slots-free">
<h2>9. ğŸ”“ Slots supplÃ©mentaires & cartes Free Slot</h2>

<p>Les slots dâ€™un land sont composÃ©s de :</p>

<ul>
  <li><strong>slots de base</strong> â†’ dÃ©finis dans <code>lands.yml</code> (champ <code>slots</code>).</li>
  <li><strong>slots bonus</strong> â†’ enregistrÃ©s en DB dans <code>player_land_slots</code>.</li>
</ul>

<p>Le joueur peut dÃ©bloquer un slot bonus en cliquant sur la tuile Â« +1 emplacement Â» :</p>

<ol>
  <li>Si le joueur possÃ¨de une carte <code>land_&lt;slug&gt;_free_slot</code> (ex : <code>land_beach_free_slot</code>), elle est consommÃ©e et le slot est ajoutÃ© gratuitement.</li>
  <li>Sinon, le coÃ»t est calculÃ© en diams : <code>base_cost * (multiplier ** extra_slots)</code> puis dÃ©bitÃ© et le slot est ajoutÃ©.</li>
</ol>

<p>Logique implÃ©mentÃ©e dans lâ€™API :</p>

<pre>
POST /api/lands/&lt;land_key&gt;/slots/buy

- VÃ©rifie le player via cookie
- Cherche une carte "land_&lt;land_key&gt;_free_slot"
- Si prÃ©sente &gt;0 :
    - dÃ©crÃ©mente / supprime la carte
- Sinon :
    - vÃ©rifie que p.diams &gt;= next_cost
    - dÃ©bite les diams
- IncrÃ©mente extra_slots dans player_land_slots
- Retourne le nouvel Ã©tat du land (total_slots, next_cost, etc.)
</pre>
</div>

<!-- ==================== SECTION 10 ==================== -->
<div class="box" id="tldr">
<h2>10. ğŸ§¾ TL;DR â€” Checklist rapide</h2>

<ul>
  <li>CrÃ©er <code>land_slug</code> dans <code>cards.yml</code> (type <code>land_access</code>).</li>
  <li>Optionnel : ajouter une carte <code>land_slug_free_slot</code> (type <code>land_slot</code>).</li>
  <li>DÃ©finir <code>slug</code> dans <code>lands.yml</code> (slots, slot_icon, coÃ»ts, loot...).</li>
  <li>CrÃ©er la route <code>/land/slug</code> dans <code>frontend.py</code> (vÃ©rif carte + appel <code>get_player_land_state()</code>).</li>
  <li>CrÃ©er le template <code>GAME_UI/lands/slug.html</code> avec :
    <ul>
      <li>une grille de slots basÃ©e sur <code>state.total_slots</code></li>
      <li>une tuile Â« +1 emplacement Â» qui appelle lâ€™API</li>
    </ul>
  </li>
  <li>CrÃ©er le JS <code>lands/slug_app.js</code> pour la collecte et lâ€™achat de slot.</li>
  <li>Ajouter un emoji pour <code>/lands</code>.</li>
  <li>Tester : achat carte â†’ accÃ¨s land â†’ collecte â†’ slots bonus + free slot cards.</li>
</ul>
</div>

</div> <!-- container -->
</body>
</html>
